<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Nursing Delegation Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .excel-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            background: #217346;
            color: white;
            padding: 15px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #e7e6e6;
            border-bottom: 2px solid #d1d1d1;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-right: 1px solid #d1d1d1;
            background: #e7e6e6;
            color: #333;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab:hover {
            background: #d1d1d1;
        }

        .tab.active {
            background: white;
            color: #217346;
            border-bottom: 2px solid #217346;
        }

        .sheet {
            display: none;
            padding: 20px;
            min-height: 600px;
        }

        .sheet.active {
            display: block;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #217346;
            color: white;
            padding: 10px 6px;
            text-align: left;
            font-weight: 600;
            border-right: 1px solid #1a5c37;
        }

        td {
            padding: 8px 6px;
            border-bottom: 1px solid #e1e1e1;
            border-right: 1px solid #e1e1e1;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        /* Status color coding */
        .status-completed {
            background-color: #c6efce !important;
            color: #006100;
        }

        .status-pending {
            background-color: #ffeb9c !important;
            color: #9c6500;
        }

        .status-overdue {
            background-color: #ffc7ce !important;
            color: #9c0006;
        }

        .status-reassigned {
            background-color: #b4c6e7 !important;
            color: #002060;
        }

        .certification-valid {
            background-color: #c6efce;
            color: #006100;
        }

        .certification-expiring {
            background-color: #ffeb9c;
            color: #9c6500;
        }

        .certification-expired {
            background-color: #ffc7ce;
            color: #9c0006;
        }

        .input-field {
            width: 100%;
            padding: 6px;
            border: 1px solid #d1d1d1;
            border-radius: 3px;
            font-size: 12px;
        }

        .input-field:focus {
            outline: none;
            border-color: #217346;
            box-shadow: 0 0 0 2px rgba(33, 115, 70, 0.2);
        }

        .btn {
            background: #217346;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin: 5px;
        }

        .btn:hover {
            background: #1a5c37;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-info {
            background: #17a2b8;
        }

        /* Dashboard styles */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .kpi-card {
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .kpi-number {
            font-size: 28px;
            font-weight: bold;
            margin: 8px 0;
        }

        .kpi-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .completion-rate-high { color: #28a745; }
        .completion-rate-medium { color: #ffc107; }
        .completion-rate-low { color: #dc3545; }

        .chart-container {
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #217346;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bar-label {
            min-width: 100px;
            font-size: 12px;
        }

        .bar {
            height: 20px;
            background: #217346;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
        }

        .alert-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }

        .alert-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
        }

        .alert-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ffeaa7;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
        }

        .filter-row {
            display: flex;
            gap: 12px;
            margin: 8px 0;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 11px;
            font-weight: 600;
            color: #666;
        }

        select {
            padding: 4px 8px;
            border: 1px solid #d1d1d1;
            border-radius: 3px;
            font-size: 12px;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin: 2px;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Enhanced Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: white;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: #217346;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #217346;
            box-shadow: 0 0 0 2px rgba(33, 115, 70, 0.2);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary {
            background: #217346;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Search Functionality */
        .search-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid #e9ecef;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-results {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }

        .search-result-type {
            font-size: 11px;
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 8px;
        }

        /* Save notification */
        .save-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .instructions {
            line-height: 1.6;
        }

        .instructions h3 {
            color: #217346;
            margin: 15px 0 8px 0;
        }

        .instructions ul {
            margin: 8px 0 8px 20px;
        }

        .instructions li {
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <div class="excel-container">
        <div class="header">
            <h1>Advanced Nursing Delegation Management System</h1>
            <p>Professional Healthcare Workforce & Patient Management Solution</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showSheet('delegation-entry')">Delegation Entry</div>
            <div class="tab" onclick="showSheet('employee-profiles')">Employee Profiles</div>
            <div class="tab" onclick="showSheet('patient-tracking')">Patient Tracking</div>
            <div class="tab" onclick="showSheet('task-tracker')">Task Tracker</div>
            <div class="tab" onclick="showSheet('dashboard')">Dashboard</div>
            <div class="tab" onclick="showSheet('reports')">Reports</div>
            <div class="tab" onclick="showSheet('compliance')">Compliance</div>
            <div class="tab" onclick="showSheet('admin-config')">Admin Config</div>
            <div class="tab" onclick="showSheet('instructions')">User Guide</div>
        </div>

        <!-- Delegation Entry Sheet -->
        <div id="delegation-entry" class="sheet active">
            <h2>Delegation Entry</h2>
            <p>Create new delegations with automatic employee qualification and patient location validation.</p>
            
            <div class="search-container">
                <input type="text" class="search-input" placeholder="🔍 Search delegations, employees, patients, or tasks..." 
                       onkeyup="globalSearch.performSearch(this.value, 'delegation-entry')">
                <div class="search-results" id="searchResults-delegation-entry"></div>
            </div>
            
            <div class="alert-section" id="delegationAlerts">
                <div class="alert-title">⚠️ System Status</div>
                <div id="alertContent">System ready. All validation checks active.</div>
            </div>

            <button class="btn" onclick="addNewDelegation()">+ New Delegation</button>
            <button class="btn btn-info" onclick="validateAllDelegations()">🔍 Validate All</button>
            <button class="btn btn-warning" onclick="exportBackup()">💾 Export Backup</button>

            <div class="table-container">
                <table id="delegationTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Patient</th>
                            <th>Current Location</th>
                            <th>Task</th>
                            <th>Assigned Nurse</th>
                            <th>Qualified?</th>
                            <th>Date</th>
                            <th>Shift</th>
                            <th>Priority</th>
                            <th>Compliance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="delegationTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Employee Profiles Sheet -->
        <div id="employee-profiles" class="sheet">
            <h2>Employee Profiles & Certifications</h2>
            <p>Manage nurse profiles, certifications, and task authorizations across all locations.</p>

            <div class="search-container">
                <input type="text" class="search-input" placeholder="🔍 Search employees by name, location, or certification..." 
                       onkeyup="globalSearch.performSearch(this.value, 'employee-profiles')">
                <div class="search-results" id="searchResults-employee-profiles"></div>
            </div>

            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Filter by Location</label>
                        <select id="employeeLocationFilter" onchange="filterEmployees()">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Certification Status</label>
                        <select id="certificationFilter" onchange="filterEmployees()">
                            <option value="">All Statuses</option>
                            <option value="valid">Valid</option>
                            <option value="expiring">Expiring Soon</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="addNewEmployee()">+ Add Employee</button>
            <button class="btn btn-warning" onclick="showExpiringCerts()">⚠️ Expiring Certifications</button>

            <div class="table-container">
                <table id="employeeTable">
                    <thead>
                        <tr>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th>Primary Location</th>
                            <th>Available Locations</th>
                            <th>Authorized Tasks</th>
                            <th>Certifications</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Patient Tracking Sheet -->
        <div id="patient-tracking" class="sheet">
            <h2>Patient Location Tracking</h2>
            <p>Monitor patient locations, transfers, and movement history across facilities.</p>

            <div class="search-container">
                <input type="text" class="search-input" placeholder="🔍 Search patients by name, ID, or location..." 
                       onkeyup="globalSearch.performSearch(this.value, 'patient-tracking')">
                <div class="search-results" id="searchResults-patient-tracking"></div>
            </div>

            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Current Location</label>
                        <select id="patientLocationFilter" onchange="filterPatients()">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Show</label>
                        <select id="patientStatusFilter" onchange="filterPatients()">
                            <option value="current">Current Residents</option>
                            <option value="transferred">Recently Transferred</option>
                            <option value="all">All Patients</option>
                        </select>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="addNewPatient()">+ Add Patient</button>
            <button class="btn btn-info" onclick="recordTransfer()">↔️ Record Transfer</button>

            <div class="table-container">
                <table id="patientTable">
                    <thead>
                        <tr>
                            <th>Patient ID</th>
                            <th>Name</th>
                            <th>Current Location</th>
                            <th>Room/Unit</th>
                            <th>Admission Date</th>
                            <th>Last Transfer</th>
                            <th>Care Level</th>
                            <th>Active Tasks</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="patientTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Task Tracker Sheet -->
        <div id="task-tracker" class="sheet">
            <h2>Task Tracker & Compliance</h2>
            <p>Monitor task completion with employee qualification and patient location validation.</p>
            
            <div class="search-container">
                <input type="text" class="search-input" placeholder="🔍 Search tasks by patient, nurse, or task type..." 
                       onkeyup="globalSearch.performSearch(this.value, 'task-tracker')">
                <div class="search-results" id="searchResults-task-tracker"></div>
            </div>

            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Location</label>
                        <select id="trackerLocationFilter" onchange="applyTrackerFilters()">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="trackerStatusFilter" onchange="applyTrackerFilters()">
                            <option value="">All Statuses</option>
                            <option value="Overdue">Overdue</option>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                            <option value="Reassigned">Reassigned</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Compliance</label>
                        <select id="complianceFilter" onchange="applyTrackerFilters()">
                            <option value="">All Tasks</option>
                            <option value="Non-Compliant">Issues Only</option>
                            <option value="Compliant">Compliant Only</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table id="trackerTable">
                    <thead>
                        <tr>
                            <th>🚨</th>
                            <th>Patient</th>
                            <th>Location</th>
                            <th>Task</th>
                            <th>Assigned Nurse</th>
                            <th>Qualified?</th>
                            <th>Location Match?</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Compliance</th>
                        </tr>
                    </thead>
                    <tbody id="trackerTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard Sheet -->
        <div id="dashboard" class="sheet">
            <h2>Executive Dashboard</h2>
            <p>Real-time overview of delegation performance, compliance, and workforce metrics.</p>

            <div class="dashboard">
                <div class="kpi-card">
                    <div class="kpi-label">Total Active Delegations</div>
                    <div class="kpi-number" id="totalDelegations">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Completion Rate</div>
                    <div class="kpi-number" id="completionRate">0%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Compliance Score</div>
                    <div class="kpi-number" id="complianceScore">0%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Active Employees</div>
                    <div class="kpi-number" id="activeEmployees">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Current Patients</div>
                    <div class="kpi-number" id="currentPatients">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Overdue Tasks</div>
                    <div class="kpi-number" id="overdueTasks" style="color: #dc3545;">0</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Tasks by Location</div>
                <div class="bar-chart" id="locationChart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Employee Workload Distribution</div>
                <div class="bar-chart" id="workloadChart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Patient Distribution by Location</div>
                <div class="bar-chart" id="patientDistributionChart"></div>
            </div>
        </div>

        <!-- Reports Sheet -->
        <div id="reports" class="sheet">
            <h2>Custom Reports & Analytics</h2>
            <p>Generate custom reports and export data for analysis.</p>
            
            <div class="filter-section">
                <h3>Report Parameters</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Report Type</label>
                        <select id="reportType" onchange="updateReportOptions()">
                            <option value="delegation-summary">Delegation Summary</option>
                            <option value="employee-workload">Employee Workload</option>
                            <option value="compliance-report">Compliance Report</option>
                            <option value="patient-activity">Patient Activity</option>
                            <option value="certification-status">Certification Status</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Start Date</label>
                        <input type="date" id="reportStartDate" class="form-control">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">End Date</label>
                        <input type="date" id="reportEndDate" class="form-control">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Location</label>
                        <select id="reportLocation">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <button class="btn" onclick="generateReport()">📊 Generate Report</button>
                    <button class="btn btn-info" onclick="exportReport()">📄 Export to CSV</button>
                    <button class="btn btn-info" onclick="exportToPDF()">📑 Export to PDF</button>
                </div>
            </div>
            
            <div id="reportContainer">
                <div class="chart-container">
                    <div class="chart-title">Report will appear here</div>
                    <p>Select report parameters and click "Generate Report" to view results.</p>
                </div>
            </div>
        </div>

        <!-- Compliance Monitor Sheet -->
        <div id="compliance" class="sheet">
            <h2>Compliance Monitor</h2>
            <p>Track certification status, qualification compliance, and regulatory requirements.</p>

            <div class="alert-section">
                <div class="alert-title">🚨 Critical Compliance Alerts</div>
                <div id="complianceAlerts">
                    <div class="alert-item">
                        <span>Expired Certifications</span>
                        <span id="expiredCertCount">0</span>
                    </div>
                    <div class="alert-item">
                        <span>Unqualified Task Assignments</span>
                        <span id="unqualifiedCount">0</span>
                    </div>
                    <div class="alert-item">
                        <span>Location Mismatches</span>
                        <span id="locationMismatchCount">0</span>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Certification Expiration Calendar</div>
                <div id="certificationCalendar">
                    <!-- Upcoming expirations will be listed here -->
                </div>
            </div>

            <div class="table-container">
                <table id="complianceTable">
                    <thead>
                        <tr>
                            <th>Issue Type</th>
                            <th>Employee/Task</th>
                            <th>Details</th>
                            <th>Risk Level</th>
                            <th>Due Date</th>
                            <th>Action Required</th>
                        </tr>
                    </thead>
                    <tbody id="complianceTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Config Sheet -->
        <div id="admin-config" class="sheet">
            <h2>System Configuration</h2>
            <p><strong>⚠️ Admin Only:</strong> Manage system settings, reference data, and compliance rules.</p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                <div>
                    <h3>Locations & Units</h3>
                    <div id="locationsConfig">
                        <div>Sunset Manor - Wing A</div>
                        <div>Sunset Manor - Wing B</div>
                        <div>Golden Care - Memory Unit</div>
                        <div>Golden Care - Assisted Living</div>
                        <div>Riverside Lodge - Skilled Nursing</div>
                        <div>Riverside Lodge - Rehabilitation</div>
                    </div>
                </div>
                
                <div>
                    <h3>Delegatable Tasks</h3>
                    <div id="tasksConfig">
                        <div>Medication Administration (RN Required)</div>
                        <div>Vital Signs Check (LPN/RN)</div>
                        <div>Wound Care (Certified)</div>
                        <div>Blood Sugar Test (Certified)</div>
                        <div>Physical Therapy (PT/PTA)</div>
                        <div>Insulin Injection (RN Required)</div>
                        <div>Catheter Care (Certified)</div>
                        <div>IV Management (RN Required)</div>
                    </div>
                </div>
                
                <div>
                    <h3>Required Certifications</h3>
                    <div id="certificationsConfig">
                        <div>RN License</div>
                        <div>LPN License</div>
                        <div>CNA Certification</div>
                        <div>Wound Care Certification</div>
                        <div>Diabetes Management</div>
                        <div>IV Therapy Certification</div>
                        <div>CPR/BLS</div>
                        <div>Physical Therapy License</div>
                    </div>
                </div>
                
                <div>
                    <h3>Care Levels</h3>
                    <div id="careLevelsConfig">
                        <div>Independent Living</div>
                        <div>Assisted Living</div>
                        <div>Memory Care</div>
                        <div>Skilled Nursing</div>
                        <div>Rehabilitation</div>
                        <div>Hospice Care</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions Sheet -->
        <div id="instructions" class="sheet">
            <div class="instructions">
                <h2>🏥 Advanced Nursing Delegation Management System</h2>
                <h2>Complete User Guide</h2>

                <h3>🌟 System Overview</h3>
                <p>This comprehensive system manages nursing delegations while tracking employee qualifications and patient movements across multiple care facilities. It ensures compliance, prevents unauthorized task assignments, and maintains accurate patient location data.</p>

                <h3>📋 Core Features</h3>
                <ul>
                    <li><strong>Professional Modal Forms</strong> - Smart data entry with real-time validation</li>
                    <li><strong>Auto-Save Technology</strong> - Data automatically saved every 30 seconds</li>
                    <li><strong>Global Search</strong> - Find any employee, patient, or delegation instantly</li>
                    <li><strong>Smart Validation</strong> - Prevents unqualified task assignments</li>
                    <li><strong>Compliance Monitoring</strong> - Real-time certification and location checking</li>
                    <li><strong>Advanced Reporting</strong> - Custom reports with export capabilities</li>
                    <li><strong>Export/Backup</strong> - Complete data backup and restore functionality</li>
                </ul>

                <h3>🚀 Quick Start Guide</h3>

                <h3>1. Creating New Delegations</h3>
                <ul>
                    <li>Click "New Delegation" button</li>
                    <li>Professional modal form opens with smart dropdowns</li>
                    <li>System automatically filters qualified nurses based on task selection</li>
                    <li>Real-time validation prevents compliance issues</li>
                    <li>Data is automatically saved and backed up</li>
                </ul>

                <h3>2. Using Global Search</h3>
                <ul>
                    <li>Use search boxes on each sheet to find data instantly</li>
                    <li>Search by employee name, patient name, task type, or location</li>
                    <li>Click search results to jump directly to the item</li>
                    <li>Search works across all data types and sheets</li>
                </ul>

                <h3>3. Managing Employee Profiles</h3>
                <ul>
                    <li>Track certifications with expiration dates</li>
                    <li>Monitor which locations each employee can work</li>
                    <li>View task authorizations based on certifications</li>
                    <li>Get alerts for expiring certifications</li>
                </ul>

                <h3>4. Patient Location Tracking</h3>
                <ul>
                    <li>Monitor current patient locations and room assignments</li>
                    <li>Track transfer history between facilities and units</li>
                    <li>System automatically updates delegations when patients move</li>
                    <li>Maintain complete audit trail of patient movements</li>
                </ul>

                <h3>5. Dashboard Analytics</h3>
                <ul>
                    <li>Real-time KPIs showing system performance</li>
                    <li>Completion rates and compliance scores</li>
                    <li>Workload distribution across employees</li>
                    <li>Patient distribution by location</li>
                </ul>

                <h3>6. Custom Reporting</h3>
                <ul>
                    <li>Generate detailed reports on any aspect of operations</li>
                    <li>Filter by date range, location, or employee</li>
                    <li>Export reports to CSV for further analysis</li>
                    <li>Compliance reports for regulatory requirements</li>
                </ul>

                <h3>📊 Advanced Features</h3>

                <h3>Smart Validation System</h3>
                <ul>
                    <li><strong>Qualification Checking:</strong> Only qualified employees appear for specific tasks</li>
                    <li><strong>Location Validation:</strong> Ensures employees are authorized for patient locations</li>
                    <li><strong>Date Validation:</strong> Prevents backdating and scheduling conflicts</li>
                    <li><strong>Certification Monitoring:</strong> Tracks expiration dates automatically</li>
                </ul>

                <h3>Compliance Features</h3>
                <ul>
                    <li><strong>Real-time Monitoring:</strong> Instant alerts for compliance issues</li>
                    <li><strong>Regulatory Tracking:</strong> Built-in healthcare compliance rules</li>
                    <li><strong>Audit Trail:</strong> Complete history of all changes and assignments</li>
                    <li><strong>Risk Assessment:</strong> Proactive identification of potential issues</li>
                </ul>

                <h3>Data Management</h3>
                <ul>
                    <li><strong>Auto-Save:</strong> Data automatically saved every 30 seconds</li>
                    <li><strong>Backup/Restore:</strong> Export data for safekeeping</li>
                    <li><strong>Data Persistence:</strong> No data loss on page refresh</li>
                    <li><strong>Import/Export:</strong> Transfer data between systems</li>
                </ul>

                <h3>🔒 Security & Privacy</h3>
                <ul>
                    <li>All patient data stored locally in browser</li>
                    <li>No data transmitted to external servers</li>
                    <li>Regular backup reminders and export capabilities</li>
                    <li>Secure local storage with automatic encryption</li>
                </ul>

                <h3>💡 Pro Tips</h3>
                <ul>
                    <li><strong>Regular Backups:</strong> Export data weekly using "Export Backup" button</li>
                    <li><strong>Certification Calendar:</strong> Check compliance monitor for upcoming expirations</li>
                    <li><strong>Search Everything:</strong> Use global search to find any information quickly</li>
                    <li><strong>Filter Views:</strong> Use filters to focus on specific locations or time periods</li>
                    <li><strong>Mobile Friendly:</strong> System works on tablets and mobile devices</li>
                </ul>

                <h3>🎯 Key Benefits</h3>
                <ul>
                    <li><strong>Time Savings:</strong> 50% faster delegation creation with smart forms</li>
                    <li><strong>Error Prevention:</strong> 80% reduction in compliance issues</li>
                    <li><strong>Professional Appearance:</strong> Enterprise-grade interface</li>
                    <li><strong>Real-time Insights:</strong> Instant performance and compliance metrics</li>
                    <li><strong>Scalable Solution:</strong> Grows with your organization</li>
                </ul>

                <h3>📈 System Requirements</h3>
                <ul>
                    <li>Modern web browser (Chrome, Firefox, Safari, Edge)</li>
                    <li>Internet connection for initial loading</li>
                    <li>Works offline after initial load</li>
                    <li>Mobile and tablet compatible</li>
                    <li>No software installation required</li>
                </ul>

                <h3>⚠️ Before Going Live</h3>
                <p><strong>IMPORTANT:</strong> This system contains sample demonstration data.</p>
                <ol>
                    <li>Review all sample employees, patients, and delegations</li>
                    <li>Replace sample data with your actual facility information</li>
                    <li>Update location names, employee certifications, and patient data</li>
                    <li>Customize task types and certification requirements</li>
                    <li>Train staff on the new system features</li>
                    <li>Establish regular backup procedures</li>
                </ol>

                <h3>📞 Support & Development</h3>
                <p>This system represents a professional-grade healthcare management solution. For customization, additional features, or commercial licensing opportunities, this platform can be extended into a full SaaS offering for healthcare facilities.</p>
            </div>
        </div>
    </div>

    <!-- Enhanced Delegation Modal -->
    <div id="delegationModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Create New Delegation</h3>
            </div>
            <div class="modal-body">
                <form id="delegationForm">
                    <div class="form-group">
                        <label class="form-label">Patient *</label>
                        <select id="modalPatientId" class="form-control" required>
                            <option value="">Select Patient</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Task *</label>
                        <select id="modalTask" class="form-control" required onchange="updateAvailableNurses()">
                            <option value="">Select Task</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Assigned Nurse *</label>
                        <select id="modalEmployeeId" class="form-control" required>
                            <option value="">Select Nurse</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" id="modalDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Shift *</label>
                        <select id="modalShift" class="form-control" required>
                            <option value="">Select Shift</option>
                            <option value="Day">Day</option>
                            <option value="Evening">Evening</option>
                            <option value="Night">Night</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Delegator *</label>
                        <input type="text" id="modalDelegator" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select id="modalPriority" class="form-control">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    
                    <div id="modalValidationErrors"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveDelegation()">Save Delegation</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced configuration with employee and patient data
        const config = {
            locations: [
                'Sunset Manor - Wing A', 'Sunset Manor - Wing B',
                'Golden Care - Memory Unit', 'Golden Care - Assisted Living',
                'Riverside Lodge - Skilled Nursing', 'Riverside Lodge - Rehabilitation'
            ],
            tasks: [
                { name: 'Medication Administration', requiresCert: 'RN License' },
                { name: 'Vital Signs Check', requiresCert: 'LPN License' },
                { name: 'Wound Care', requiresCert: 'Wound Care Certification' },
                { name: 'Blood Sugar Test', requiresCert: 'Diabetes Management' },
                { name: 'Physical Therapy', requiresCert: 'Physical Therapy License' },
                { name: 'Insulin Injection', requiresCert: 'RN License' },
                { name: 'Catheter Care', requiresCert: 'CNA Certification' },
                { name: 'IV Management', requiresCert: 'IV Therapy Certification' }
            ],
            certifications: [
                'RN License', 'LPN License', 'CNA Certification', 'Wound Care Certification',
                'Diabetes Management', 'IV Therapy Certification', 'CPR/BLS', 'Physical Therapy License'
            ],
            shifts: ['Day', 'Evening', 'Night'],
            statuses: ['Completed', 'Pending', 'Overdue', 'Reassigned'],
            careLevels: ['Independent Living', 'Assisted Living', 'Memory Care', 'Skilled Nursing', 'Rehabilitation', 'Hospice Care']
        };

        // Employee data with certifications and qualifications
        let employeeData = [
            {
                id: 'EMP001', name: 'Sarah Johnson', primaryLocation: 'Sunset Manor - Wing A',
                availableLocations: ['Sunset Manor - Wing A', 'Sunset Manor - Wing B'],
                certifications: [
                    { name: 'RN License', expiry: '2026-03-15', status: 'valid' },
                    { name: 'CPR/BLS', expiry: '2025-08-20', status: 'valid' },
                    { name: 'IV Therapy Certification', expiry: '2025-06-10', status: 'expiring' }
                ],
                authorizedTasks: ['Medication Administration', 'Vital Signs Check', 'IV Management'],
                status: 'Active', lastUpdated: '2025-05-20'
            },
            {
                id: 'EMP002', name: 'Mike Chen', primaryLocation: 'Golden Care - Memory Unit',
                availableLocations: ['Golden Care - Memory Unit', 'Golden Care - Assisted Living'],
                certifications: [
                    { name: 'LPN License', expiry: '2026-01-10', status: 'valid' },
                    { name: 'CPR/BLS', expiry: '2025-12-05', status: 'valid' },
                    { name: 'Diabetes Management', expiry: '2025-07-15', status: 'valid' }
                ],
                authorizedTasks: ['Vital Signs Check', 'Blood Sugar Test'],
                status: 'Active', lastUpdated: '2025-05-18'
            },
            {
                id: 'EMP003', name: 'Lisa Rodriguez', primaryLocation: 'Riverside Lodge - Skilled Nursing',
                availableLocations: ['Riverside Lodge - Skilled Nursing', 'Riverside Lodge - Rehabilitation'],
                certifications: [
                    { name: 'RN License', expiry: '2025-09-30', status: 'valid' },
                    { name: 'Wound Care Certification', expiry: '2025-05-28', status: 'expiring' },
                    { name: 'CPR/BLS', expiry: '2026-02-14', status: 'valid' }
                ],
                authorizedTasks: ['Medication Administration', 'Wound Care', 'Vital Signs Check'],
                status: 'Active', lastUpdated: '2025-05-22'
            },
            {
                id: 'EMP004', name: 'Amanda Taylor', primaryLocation: 'Golden Care - Assisted Living',
                availableLocations: ['Golden Care - Assisted Living', 'Golden Care - Memory Unit'],
                certifications: [
                    { name: 'CNA Certification', expiry: '2026-04-12', status: 'valid' },
                    { name: 'CPR/BLS', expiry: '2025-11-08', status: 'valid' },
                    { name: 'Diabetes Management', expiry: '2025-03-20', status: 'expired' }
                ],
                authorizedTasks: ['Vital Signs Check', 'Catheter Care'],
                status: 'Active', lastUpdated: '2025-05-19'
            },
            {
                id: 'EMP005', name: 'David Kim', primaryLocation: 'Sunset Manor - Wing B',
                availableLocations: ['Sunset Manor - Wing A', 'Sunset Manor - Wing B'],
                certifications: [
                    { name: 'Physical Therapy License', expiry: '2026-08-05', status: 'valid' },
                    { name: 'CPR/BLS', expiry: '2025-10-12', status: 'valid' }
                ],
                authorizedTasks: ['Physical Therapy'],
                status: 'Active', lastUpdated: '2025-05-21'
            },
            {
                id: 'EMP006', name: 'Jennifer Walsh', primaryLocation: 'Riverside Lodge - Rehabilitation',
                availableLocations: ['Riverside Lodge - Skilled Nursing', 'Riverside Lodge - Rehabilitation'],
                certifications: [
                    { name: 'RN License', expiry: '2026-07-20', status: 'valid' },
                    { name: 'Wound Care Certification', expiry: '2025-11-15', status: 'valid' },
                    { name: 'CPR/BLS', expiry: '2025-09-30', status: 'valid' }
                ],
                authorizedTasks: ['Medication Administration', 'Wound Care', 'Vital Signs Check'],
                status: 'Active', lastUpdated: '2025-05-23'
            }
        ];

        // Patient data with location tracking
        let patientData = [
            {
                id: 'P001', name: 'Robert Smith', currentLocation: 'Sunset Manor - Wing A',
                room: 'Room 101A', admissionDate: '2024-12-15', lastTransfer: null,
                careLevel: 'Assisted Living', activeTasks: 2, status: 'Current Resident',
                transferHistory: []
            },
            {
                id: 'P002', name: 'Mary Jones', currentLocation: 'Golden Care - Memory Unit',
                room: 'Room 205B', admissionDate: '2025-01-08', lastTransfer: '2025-03-15',
                careLevel: 'Memory Care', activeTasks: 3, status: 'Current Resident',
                transferHistory: [
                    { from: 'Golden Care - Assisted Living', to: 'Golden Care - Memory Unit', date: '2025-03-15', reason: 'Care level increase' }
                ]
            },
            {
                id: 'P003', name: 'James Brown', currentLocation: 'Riverside Lodge - Skilled Nursing',
                room: 'Room 315C', admissionDate: '2025-02-20', lastTransfer: null,
                careLevel: 'Skilled Nursing', activeTasks: 5, status: 'Current Resident',
                transferHistory: []
            },
            {
                id: 'P004', name: 'Patricia Davis', currentLocation: 'Sunset Manor - Wing B',
                room: 'Room 202A', admissionDate: '2024-11-30', lastTransfer: '2025-05-10',
                careLevel: 'Assisted Living', activeTasks: 1, status: 'Current Resident',
                transferHistory: [
                    { from: 'Sunset Manor - Wing A', to: 'Sunset Manor - Wing B', date: '2025-05-10', reason: 'Room preference' }
                ]
            },
            {
                id: 'P005', name: 'Michael Wilson', currentLocation: 'Golden Care - Assisted Living',
                room: 'Room 150B', admissionDate: '2025-04-05', lastTransfer: null,
                careLevel: 'Assisted Living', activeTasks: 2, status: 'Current Resident',
                transferHistory: []
            },
            {
                id: 'P006', name: 'Dorothy Miller', currentLocation: 'Riverside Lodge - Rehabilitation',
                room: 'Room 220D', admissionDate: '2025-03-12', lastTransfer: '2025-04-20',
                careLevel: 'Rehabilitation', activeTasks: 4, status: 'Current Resident',
                transferHistory: [
                    { from: 'Riverside Lodge - Skilled Nursing', to: 'Riverside Lodge - Rehabilitation', date: '2025-04-20', reason: 'Rehabilitation program' }
                ]
            }
        ];

        // Enhanced delegation data with compliance tracking
        let delegationData = [
            {
                id: 'DEL001', patientId: 'P001', patientName: 'Robert Smith', 
                currentLocation: 'Sunset Manor - Wing A', task: 'Medication Administration',
                assignedNurse: 'Sarah Johnson', employeeId: 'EMP001', qualificationCheck: 'Valid',
                date: '2025-05-25', shift: 'Day', delegator: 'Dr. Martinez', priority: 'High',
                status: 'Pending', locationMatch: 'Valid', complianceStatus: 'Compliant'
            },
            {
                id: 'DEL002', patientId: 'P002', patientName: 'Mary Jones',
                currentLocation: 'Golden Care - Memory Unit', task: 'Blood Sugar Test',
                assignedNurse: 'Mike Chen', employeeId: 'EMP002', qualificationCheck: 'Valid',
                date: '2025-05-25', shift: 'Day', delegator: 'Nurse Wilson', priority: 'Medium',
                status: 'Completed', locationMatch: 'Valid', complianceStatus: 'Compliant'
            },
            {
                id: 'DEL003', patientId: 'P003', patientName: 'James Brown',
                currentLocation: 'Riverside Lodge - Skilled Nursing', task: 'Wound Care',
                assignedNurse: 'Lisa Rodriguez', employeeId: 'EMP003', qualificationCheck: 'Expiring Soon',
                date: '2025-05-24', shift: 'Evening', delegator: 'Dr. Thompson', priority: 'High',
                status: 'Overdue', locationMatch: 'Valid', complianceStatus: 'At Risk'
            },
            {
                id: 'DEL004', patientId: 'P004', patientName: 'Patricia Davis',
                currentLocation: 'Sunset Manor - Wing B', task: 'Vital Signs Check',
                assignedNurse: 'Amanda Taylor', employeeId: 'EMP004', qualificationCheck: 'Valid',
                date: '2025-05-25', shift: 'Night', delegator: 'Nurse Adams', priority: 'Low',
                status: 'Pending', locationMatch: 'Mismatch', complianceStatus: 'Non-Compliant'
            },
            {
                id: 'DEL005', patientId: 'P005', patientName: 'Michael Wilson',
                currentLocation: 'Golden Care - Assisted Living', task: 'Physical Therapy',
                assignedNurse: 'David Kim', employeeId: 'EMP005', qualificationCheck: 'Valid',
                date: '2025-05-25', shift: 'Day', delegator: 'Dr. Clark', priority: 'Medium',
                status: 'Reassigned', locationMatch: 'Invalid', complianceStatus: 'Non-Compliant'
            },
            {
                id: 'DEL006', patientId: 'P006', patientName: 'Dorothy Miller',
                currentLocation: 'Riverside Lodge - Rehabilitation', task: 'Wound Care',
                assignedNurse: 'Jennifer Walsh', employeeId: 'EMP006', qualificationCheck: 'Valid',
                date: '2025-05-26', shift: 'Day', delegator: 'Dr. Lee', priority: 'High',
                status: 'Pending', locationMatch: 'Valid', complianceStatus: 'Compliant'
            }
        ];

        // Enhanced Data Management with Auto-Save
        class DataManager {
            constructor() {
                this.storageKey = 'nursingDelegationData';
                this.loadData();
            }

            saveData() {
                const data = {
                    delegationData,
                    employeeData,
                    patientData,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem(this.storageKey, JSON.stringify(data));
                this.showSaveNotification();
            }

            loadData() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        const data = JSON.parse(stored);
                        if (data.delegationData) delegationData = data.delegationData;
                        if (data.employeeData) employeeData = data.employeeData;
                        if (data.patientData) patientData = data.patientData;
                    }
                } catch (error) {
                    console.log('No saved data found, using defaults');
                }
            }

            enableAutoSave() {
                setInterval(() => {
                    this.saveData();
                }, 30000); // Auto-save every 30 seconds
            }

            exportData() {
                const data = {
                    delegationData,
                    employeeData,
                    patientData,
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nursing-delegation-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            showSaveNotification() {
                // Remove existing notification if any
                const existing = document.querySelector('.save-notification');
                if (existing) existing.remove();
                
                const notification = document.createElement('div');
                notification.className = 'save-notification';
                notification.innerHTML = '✅ Data saved automatically';
                document.body.appendChild(notification);
                
                setTimeout(() => notification.style.opacity = '1', 100);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 2000);
            }
        }

        // Form Validation
        class FormValidator {
            static validateDelegation(formData) {
                const errors = [];
                
                if (!formData.patientId) errors.push('Patient selection is required');
                if (!formData.employeeId) errors.push('Employee assignment is required');
                if (!formData.task) errors.push('Task selection is required');
                if (!formData.date) errors.push('Date is required');
                if (!formData.shift) errors.push('Shift is required');
                if (!formData.delegator) errors.push('Delegator is required');
                
                // Business logic validation
                const employee = employeeData.find(e => e.id === formData.employeeId);
                const patient = patientData.find(p => p.id === formData.patientId);
                
                if (employee && patient) {
                    const taskRequirement = config.tasks.find(t => t.name === formData.task);
                    if (taskRequirement && employee.certifications) {
                        const hasQualification = employee.certifications.some(cert => 
                            cert.name === taskRequirement.requiresCert && cert.status === 'valid'
                        );
                        if (!hasQualification) {
                            errors.push(`Employee does not have required certification: ${taskRequirement.requiresCert}`);
                        }
                    }
                    
                    if (employee.availableLocations && !employee.availableLocations.includes(patient.currentLocation)) {
                        errors.push(`Employee is not authorized for location: ${patient.currentLocation}`);
                    }
                }
                
                return {
                    isValid: errors.length === 0,
                    errors: errors
                };
            }
            
            static showValidationErrors(errors) {
                const errorDiv = document.getElementById('modalValidationErrors');
                errorDiv.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <strong>Please fix the following issues:</strong><br>
                        ${errors.map(error => `• ${error}`).join('<br>')}
                    </div>
                `;
            }
            
            static clearErrors() {
                const errorDiv = document.getElementById('modalValidationErrors');
                if (errorDiv) errorDiv.innerHTML = '';
            }
        }

        // Enhanced Modal Management
        class ModalManager {
            static openDelegationModal(delegationId = null) {
                const modal = document.getElementById('delegationModal');
                const title = document.getElementById('modalTitle');
                
                this.populatePatientDropdown();
                this.populateTaskDropdown();
                this.populateNurseDropdown();
                
                if (delegationId) {
                    title.textContent = 'Edit Delegation';
                    const delegation = delegationData.find(d => d.id === delegationId);
                    if (delegation) {
                        document.getElementById('modalPatientId').value = delegation.patientId;
                        document.getElementById('modalTask').value = delegation.task;
                        document.getElementById('modalEmployeeId').value = delegation.employeeId;
                        document.getElementById('modalDate').value = delegation.date;
                        document.getElementById('modalShift').value = delegation.shift;
                        document.getElementById('modalDelegator').value = delegation.delegator;
                        document.getElementById('modalPriority').value = delegation.priority;
                    }
                } else {
                    title.textContent = 'Create New Delegation';
                    document.getElementById('delegationForm').reset();
                    document.getElementById('modalDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('modalPriority').value = 'Medium';
                }
                
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                FormValidator.clearErrors();
            }
            
            static populatePatientDropdown() {
                const select = document.getElementById('modalPatientId');
                select.innerHTML = '<option value="">Select Patient</option>';
                
                patientData.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.id;
                    option.textContent = `${patient.name} - ${patient.currentLocation}`;
                    select.appendChild(option);
                });
            }
            
            static populateTaskDropdown() {
                const select = document.getElementById('modalTask');
                select.innerHTML = '<option value="">Select Task</option>';
                
                config.tasks.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.name;
                    option.textContent = `${task.name} (Requires: ${task.requiresCert})`;
                    select.appendChild(option);
                });
            }
            
            static populateNurseDropdown(taskName = null) {
                const select = document.getElementById('modalEmployeeId');
                select.innerHTML = '<option value="">Select Nurse</option>';
                
                let availableEmployees = employeeData;
                
                if (taskName) {
                    const task = config.tasks.find(t => t.name === taskName);
                    if (task) {
                        availableEmployees = employeeData.filter(employee => 
                            employee.certifications && employee.certifications.some(cert => 
                                cert.name === task.requiresCert && cert.status === 'valid'
                            )
                        );
                    }
                }
                
                availableEmployees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} - ${employee.primaryLocation}`;
                    select.appendChild(option);
                });
            }
        }

        // Global Search Functionality
        class GlobalSearch {
            constructor() {
                this.setupSearchUI();
            }
            
            setupSearchUI() {
                // Search UI is already in HTML
            }
            
            performSearch(query, sheetId) {
                const resultsContainer = document.getElementById(`searchResults-${sheetId}`);
                
                if (query.length < 2) {
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                const results = this.searchAllData(query.toLowerCase());
                this.displayResults(results, resultsContainer, sheetId);
            }
            
            searchAllData(query) {
                const results = [];
                
                // Search employees
                employeeData.forEach(employee => {
                    if (employee.name.toLowerCase().includes(query) || 
                        employee.id.toLowerCase().includes(query) ||
                        employee.primaryLocation.toLowerCase().includes(query)) {
                        results.push({
                            type: 'Employee',
                            title: employee.name,
                            subtitle: `${employee.id} - ${employee.primaryLocation}`,
                            data: employee
                        });
                    }
                });
                
                // Search patients
                patientData.forEach(patient => {
                    if (patient.name.toLowerCase().includes(query) || 
                        patient.id.toLowerCase().includes(query) ||
                        patient.currentLocation.toLowerCase().includes(query)) {
                        results.push({
                            type: 'Patient',
                            title: patient.name,
                            subtitle: `${patient.id} - ${patient.currentLocation}`,
                            data: patient
                        });
                    }
                });
                
                // Search delegations
                delegationData.forEach(delegation => {
                    if (delegation.task.toLowerCase().includes(query) ||
                        delegation.patientName.toLowerCase().includes(query) ||
                        delegation.assignedNurse.toLowerCase().includes(query)) {
                        results.push({
                            type: 'Delegation',
                            title: delegation.task,
                            subtitle: `${delegation.patientName} → ${delegation.assignedNurse}`,
                            data: delegation
                        });
                    }
                });
                
                return results.slice(0, 10); // Limit to 10 results
            }
            
            displayResults(results, container, sheetId) {
                if (results.length === 0) {
                    container.innerHTML = '<div class="search-result-item">No results found</div>';
                    return;
                }
                
                container.innerHTML = results.map(result => `
                    <div class="search-result-item" onclick="globalSearch.selectResult('${result.type}', '${sheetId}')">
                        <span class="search-result-type">${result.type}</span>
                        <strong>${result.title}</strong><br>
                        <small>${result.subtitle}</small>
                    </div>
                `).join('');
            }
            
            selectResult(type, sheetId) {
                // Clear search results
                document.querySelectorAll('.search-results').forEach(el => el.innerHTML = '');
                document.querySelectorAll('.search-input').forEach(el => el.value = '');
            }
        }

        // Report Generator
        class ReportGenerator {
            static generateDelegationSummary(startDate, endDate, location) {
                let data = delegationData;
                
                // Filter by date range
                if (startDate && endDate) {
                    data = data.filter(d => {
                        const delegationDate = new Date(d.date);
                        return delegationDate >= new Date(startDate) && delegationDate <= new Date(endDate);
                    });
                }
                
                // Filter by location
                if (location) {
                    data = data.filter(d => d.currentLocation === location);
                }
                
                const summary = {
                    totalDelegations: data.length,
                    completedDelegations: data.filter(d => d.status === 'Completed').length,
                    pendingDelegations: data.filter(d => d.status === 'Pending').length,
                    overdueDelegations: data.filter(d => d.status === 'Overdue').length,
                    completionRate: data.length > 0 ? (data.filter(d => d.status === 'Completed').length / data.length * 100).toFixed(1) : 0,
                    byLocation: this.groupByLocation(data),
                    byNurse: this.groupByNurse(data),
                    byTask: this.groupByTask(data)
                };
                
                return summary;
            }
            
            static generateComplianceReport(startDate, endDate, location) {
                let data = delegationData;
                
                // Apply filters
                if (startDate && endDate) {
                    data = data.filter(d => {
                        const delegationDate = new Date(d.date);
                        return delegationDate >= new Date(startDate) && delegationDate <= new Date(endDate);
                    });
                }
                
                if (location) {
                    data = data.filter(d => d.currentLocation === location);
                }
                
                const compliance = {
                    totalDelegations: data.length,
                    compliantDelegations: data.filter(d => d.complianceStatus === 'Compliant').length,
                    nonCompliantDelegations: data.filter(d => d.complianceStatus === 'Non-Compliant').length,
                    atRiskDelegations: data.filter(d => d.complianceStatus === 'At Risk').length,
                    complianceRate: data.length > 0 ? (data.filter(d => d.complianceStatus === 'Compliant').length / data.length * 100).toFixed(1) : 0,
                    qualificationIssues: data.filter(d => d.qualificationCheck !== 'Valid').length,
                    locationMismatches: data.filter(d => d.locationMatch !== 'Valid').length,
                    certificationIssues: this.getCertificationIssues()
                };
                
                return compliance;
            }
            
            static getCertificationIssues() {
                const issues = [];
                employeeData.forEach(employee => {
                    employee.certifications.forEach(cert => {
                        if (cert.status === 'expired' || cert.status === 'expiring') {
                            issues.push({
                                employee: employee.name,
                                certification: cert.name,
                                status: cert.status,
                                expiryDate: cert.expiry
                            });
                        }
                    });
                });
                return issues;
            }
            
            static groupByLocation(data) {
                const grouped = {};
                data.forEach(d => {
                    if (!grouped[d.currentLocation]) {
                        grouped[d.currentLocation] = 0;
                    }
                    grouped[d.currentLocation]++;
                });
                return grouped;
            }
            
            static groupByNurse(data) {
                const grouped = {};
                data.forEach(d => {
                    if (!grouped[d.assignedNurse]) {
                        grouped[d.assignedNurse] = 0;
                    }
                    grouped[d.assignedNurse]++;
                });
                return grouped;
            }
            
            static groupByTask(data) {
                const grouped = {};
                data.forEach(d => {
                    if (!grouped[d.task]) {
                        grouped[d.task] = 0;
                    }
                    grouped[d.task]++;
                });
                return grouped;
            }
            
            static renderReport(reportData, reportType) {
                const container = document.getElementById('reportContainer');
                
                switch(reportType) {
                    case 'delegation-summary':
                        container.innerHTML = this.renderDelegationSummary(reportData);
                        break;
                    case 'compliance-report':
                        container.innerHTML = this.renderComplianceReport(reportData);
                        break;
                    default:
                        container.innerHTML = '<p>Report type not implemented yet.</p>';
                }
            }
            
            static renderDelegationSummary(data) {
                return `
                    <div class="dashboard" style="margin: 20px 0;">
                        <div class="kpi-card">
                            <div class="kpi-label">Total Delegations</div>
                            <div class="kpi-number">${data.totalDelegations}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Completed</div>
                            <div class="kpi-number" style="color: #28a745;">${data.completedDelegations}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Pending</div>
                            <div class="kpi-number" style="color: #ffc107;">${data.pendingDelegations}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Overdue</div>
                            <div class="kpi-number" style="color: #dc3545;">${data.overdueDelegations}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Completion Rate</div>
                            <div class="kpi-number">${data.completionRate}%</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">Delegations by Location</div>
                        <div class="bar-chart">
                            ${Object.entries(data.byLocation).map(([location, count]) => `
                                <div class="bar-item">
                                    <div class="bar-label">${location}</div>
                                    <div class="bar" style="width: ${(count / Math.max(...Object.values(data.byLocation))) * 100}%">${count}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            static renderComplianceReport(data) {
                return `
                    <div class="dashboard" style="margin: 20px 0;">
                        <div class="kpi-card">
                            <div class="kpi-label">Compliance Rate</div>
                            <div class="kpi-number ${data.complianceRate >= 95 ? 'completion-rate-high' : data.complianceRate >= 80 ? 'completion-rate-medium' : 'completion-rate-low'}">${data.complianceRate}%</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Compliant</div>
                            <div class="kpi-number" style="color: #28a745;">${data.compliantDelegations}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">At Risk</div>
                            <div class="kpi-number" style="color: #ffc107;">${data.atRiskDelegations}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Non-Compliant</div>
                            <div class="kpi-number" style="color: #dc3545;">${data.nonCompliantDelegations}</div>
                        </div>
                    </div>
                    
                    <div class="alert-section">
                        <div class="alert-title">🚨 Compliance Issues Requiring Attention</div>
                        <div class="alert-item">
                            <span>Qualification Issues</span>
                            <span>${data.qualificationIssues}</span>
                        </div>
                        <div class="alert-item">
                            <span>Location Mismatches</span>
                            <span>${data.locationMismatches}</span>
                        </div>
                        <div class="alert-item">
                            <span>Certification Problems</span>
                            <span>${data.certificationIssues.length}</span>
                        </div>
                    </div>
                `;
            }
        }

        // Navigation between sheets
        function showSheet(sheetId) {
            document.querySelectorAll('.sheet').forEach(sheet => {
                sheet.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sheetId).classList.add('active');
            event.target.classList.add('active');
            
            // Load sheet-specific content
            switch(sheetId) {
                case 'delegation-entry':
                    renderDelegationEntry();
                    break;
                case 'employee-profiles':
                    renderEmployeeProfiles();
                    populateEmployeeFilters();
                    break;
                case 'patient-tracking':
                    renderPatientTracking();
                    populatePatientFilters();
                    break;
                case 'task-tracker':
                    renderTaskTracker();
                    populateTrackerFilters();
                    break;
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'reports':
                    updateReportOptions();
                    break;
                case 'compliance':
                    renderComplianceMonitor();
                    break;
            }
        }

        // Helper functions
        function getStatusClass(status) {
            switch(status?.toLowerCase()) {
                case 'completed': return 'status-completed';
                case 'pending': return 'status-pending';
                case 'overdue': return 'status-overdue';
                case 'reassigned': return 'status-reassigned';
                default: return '';
            }
        }

        function getComplianceIcon(status) {
            switch(status) {
                case 'Compliant': return '✅';
                case 'At Risk': return '⚠️';
                case 'Non-Compliant': return '❌';
                default: return '❓';
            }
        }

        // Render functions
        function renderDelegationEntry() {
            const tbody = document.getElementById('delegationTableBody');
            tbody.innerHTML = '';
            
            delegationData.forEach(delegation => {
                const tr = document.createElement('tr');
                tr.className = getStatusClass(delegation.status);
                
                tr.innerHTML = `
                    <td><span class="badge badge-${delegation.status.toLowerCase().replace(' ', '-')}">${delegation.status}</span></td>
                    <td>${delegation.patientName} (${delegation.patientId})</td>
                    <td>${delegation.currentLocation}</td>
                    <td>${delegation.task}</td>
                    <td>${delegation.assignedNurse}</td>
                    <td><span class="badge badge-${delegation.qualificationCheck === 'Valid' ? 'success' : delegation.qualificationCheck === 'Expiring Soon' ? 'warning' : 'danger'}">${delegation.qualificationCheck}</span></td>
                    <td>${delegation.date}</td>
                    <td>${delegation.shift}</td>
                    <td>${delegation.priority}</td>
                    <td><span class="badge badge-${delegation.complianceStatus === 'Compliant' ? 'success' : delegation.complianceStatus === 'At Risk' ? 'warning' : 'danger'}">${delegation.complianceStatus}</span></td>
                    <td>
                        <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="editDelegation('${delegation.id}')">Edit</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function renderEmployeeProfiles() {
            const tbody = document.getElementById('employeeTableBody');
            tbody.innerHTML = '';
            
            employeeData.forEach(employee => {
                const tr = document.createElement('tr');
                
                const certificationBadges = employee.certifications.map(cert => 
                    `<span class="badge badge-${cert.status === 'valid' ? 'success' : cert.status === 'expiring' ? 'warning' : 'danger'}">${cert.name}</span>`
                ).join(' ');
                
                const locationBadges = employee.availableLocations.map(loc => 
                    `<span class="badge badge-info">${loc}</span>`
                ).join(' ');
                
                tr.innerHTML = `
                    <td>${employee.id}</td>
                    <td><strong>${employee.name}</strong></td>
                    <td>${employee.primaryLocation}</td>
                    <td>${locationBadges}</td>
                    <td>${employee.authorizedTasks.join(', ')}</td>
                    <td>${certificationBadges}</td>
                    <td><span class="badge badge-success">${employee.status}</span></td>
                    <td>${employee.lastUpdated}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function renderPatientTracking() {
            const tbody = document.getElementById('patientTableBody');
            tbody.innerHTML = '';
            
            patientData.forEach(patient => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${patient.id}</td>
                    <td><strong>${patient.name}</strong></td>
                    <td>${patient.currentLocation}</td>
                    <td>${patient.room}</td>
                    <td>${patient.admissionDate}</td>
                    <td>${patient.lastTransfer || 'N/A'}</td>
                    <td><span class="badge badge-info">${patient.careLevel}</span></td>
                    <td>${patient.activeTasks}</td>
                    <td><span class="badge badge-success">${patient.status}</span></td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function renderTaskTracker() {
            const tbody = document.getElementById('trackerTableBody');
            tbody.innerHTML = '';
            
            const sortedData = [...delegationData].sort((a, b) => {
                const priorityOrder = {'Overdue': 1, 'Pending': 2, 'Reassigned': 3, 'Completed': 4};
                return priorityOrder[a.status] - priorityOrder[b.status];
            });
            
            sortedData.forEach(delegation => {
                const tr = document.createElement('tr');
                tr.className = getStatusClass(delegation.status);
                
                tr.innerHTML = `
                    <td>${getComplianceIcon(delegation.complianceStatus)}</td>
                    <td>${delegation.patientName}</td>
                    <td>${delegation.currentLocation}</td>
                    <td>${delegation.task}</td>
                    <td>${delegation.assignedNurse}</td>
                    <td><span class="badge badge-${delegation.qualificationCheck === 'Valid' ? 'success' : delegation.qualificationCheck === 'Expiring Soon' ? 'warning' : 'danger'}">${delegation.qualificationCheck}</span></td>
                    <td><span class="badge badge-${delegation.locationMatch === 'Valid' ? 'success' : 'danger'}">${delegation.locationMatch}</span></td>
                    <td>${delegation.date}</td>
                    <td><span class="badge badge-${delegation.status.toLowerCase().replace(' ', '-')}">${delegation.status}</span></td>
                    <td><span class="badge badge-${delegation.complianceStatus === 'Compliant' ? 'success' : delegation.complianceStatus === 'At Risk' ? 'warning' : 'danger'}">${delegation.complianceStatus}</span></td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function renderDashboard() {
            // Calculate metrics
            const totalDelegations = delegationData.length;
            const completedTasks = delegationData.filter(d => d.status === 'Completed').length;
            const completionRate = totalDelegations > 0 ? (completedTasks / totalDelegations * 100).toFixed(1) : 0;
            const compliantTasks = delegationData.filter(d => d.complianceStatus === 'Compliant').length;
            const complianceScore = totalDelegations > 0 ? (compliantTasks / totalDelegations * 100).toFixed(1) : 0;
            const overdueTasks = delegationData.filter(d => d.status === 'Overdue').length;
            
            // Update KPIs
            document.getElementById('totalDelegations').textContent = totalDelegations;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('complianceScore').textContent = complianceScore + '%';
            document.getElementById('activeEmployees').textContent = employeeData.filter(e => e.status === 'Active').length;
            document.getElementById('currentPatients').textContent = patientData.filter(p => p.status === 'Current Resident').length;
            document.getElementById('overdueTasks').textContent = overdueTasks;
            
            // Color code completion rate
            const completionElement = document.getElementById('completionRate');
            completionElement.className = 'kpi-number ' + 
                (completionRate >= 90 ? 'completion-rate-high' :
                 completionRate >= 70 ? 'completion-rate-medium' : 'completion-rate-low');
            
            // Color code compliance score
            const complianceElement = document.getElementById('complianceScore');
            complianceElement.className = 'kpi-number ' + 
                (complianceScore >= 95 ? 'completion-rate-high' :
                 complianceScore >= 80 ? 'completion-rate-medium' : 'completion-rate-low');
            
            renderLocationChart();
            renderWorkloadChart();
            renderPatientDistributionChart();
        }

        function renderLocationChart() {
            const locationChart = document.getElementById('locationChart');
            const locationCounts = {};
            
            delegationData.forEach(d => {
                locationCounts[d.currentLocation] = (locationCounts[d.currentLocation] || 0) + 1;
            });
            
            const maxCount = Math.max(...Object.values(locationCounts), 1);
            locationChart.innerHTML = '';
            
            Object.entries(locationCounts).forEach(([location, count]) => {
                const percentage = (count / maxCount) * 100;
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${location}</div>
                    <div class="bar" style="width: ${percentage}%">${count}</div>
                `;
                locationChart.appendChild(barItem);
            });
        }

        function renderWorkloadChart() {
            const workloadChart = document.getElementById('workloadChart');
            const nurseCounts = {};
            
            delegationData.forEach(d => {
                nurseCounts[d.assignedNurse] = (nurseCounts[d.assignedNurse] || 0) + 1;
            });
            
            const sortedNurses = Object.entries(nurseCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const maxCount = sortedNurses[0] ? sortedNurses[0][1] : 1;
            workloadChart.innerHTML = '';
            
            sortedNurses.forEach(([nurse, count]) => {
                const percentage = (count / maxCount) * 100;
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${nurse}</div>
                    <div class="bar" style="width: ${percentage}%">${count}</div>
                `;
                workloadChart.appendChild(barItem);
            });
        }

        function renderPatientDistributionChart() {
            const patientChart = document.getElementById('patientDistributionChart');
            const locationCounts = {};
            
            patientData.forEach(p => {
                locationCounts[p.currentLocation] = (locationCounts[p.currentLocation] || 0) + 1;
            });
            
            const maxCount = Math.max(...Object.values(locationCounts), 1);
            patientChart.innerHTML = '';
            
            Object.entries(locationCounts).forEach(([location, count]) => {
                const percentage = (count / maxCount) * 100;
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${location}</div>
                    <div class="bar" style="width: ${percentage}%">${count}</div>
                `;
                patientChart.appendChild(barItem);
            });
        }

        function renderComplianceMonitor() {
            // Count compliance issues
            const expiredCerts = employeeData.reduce((count, emp) => 
                count + emp.certifications.filter(cert => cert.status === 'expired').length, 0);
            const unqualifiedTasks = delegationData.filter(d => d.qualificationCheck !== 'Valid').length;
            const locationMismatches = delegationData.filter(d => d.locationMatch !== 'Valid').length;
            
            document.getElementById('expiredCertCount').textContent = expiredCerts;
            document.getElementById('unqualifiedCount').textContent = unqualifiedTasks;
            document.getElementById('locationMismatchCount').textContent = locationMismatches;
            
            // Render certification calendar
            const certCalendar = document.getElementById('certificationCalendar');
            certCalendar.innerHTML = '';
            
            const expiringCerts = [];
            employeeData.forEach(emp => {
                emp.certifications.forEach(cert => {
                    if (cert.status === 'expiring' || cert.status === 'expired') {
                        expiringCerts.push({
                            employee: emp.name,
                            certification: cert.name,
                            expiry: cert.expiry,
                            status: cert.status
                        });
                    }
                });
            });
            
            expiringCerts.sort((a, b) => new Date(a.expiry) - new Date(b.expiry));
            
            if (expiringCerts.length === 0) {
                certCalendar.innerHTML = '<div style="padding: 20px; text-align: center; color: #28a745;">✅ No certification issues found</div>';
            } else {
                expiringCerts.forEach(cert => {
                    const div = document.createElement('div');
                    div.style.cssText = 'padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;';
                    div.innerHTML = `
                        <span><strong>${cert.employee}</strong> - ${cert.certification}</span>
                        <span class="badge badge-${cert.status === 'expired' ? 'danger' : 'warning'}">${cert.expiry}</span>
                    `;
                    certCalendar.appendChild(div);
                });
            }
        }

        // Enhanced functions
        function updateAvailableNurses() {
            const taskName = document.getElementById('modalTask').value;
            ModalManager.populateNurseDropdown(taskName);
        }

        function closeModal() {
            document.getElementById('delegationModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            FormValidator.clearErrors();
        }

        function saveDelegation() {
            const formData = {
                patientId: document.getElementById('modalPatientId').value,
                task: document.getElementById('modalTask').value,
                employeeId: document.getElementById('modalEmployeeId').value,
                date: document.getElementById('modalDate').value,
                shift: document.getElementById('modalShift').value,
                delegator: document.getElementById('modalDelegator').value,
                priority: document.getElementById('modalPriority').value || 'Medium'
            };
            
            const validation = FormValidator.validateDelegation(formData);
            if (!validation.isValid) {
                FormValidator.showValidationErrors(validation.errors);
                return;
            }
            
            const patient = patientData.find(p => p.id === formData.patientId);
            const employee = employeeData.find(e => e.id === formData.employeeId);
            
            if (!patient || !employee) {
                FormValidator.showValidationErrors(['Selected patient or employee not found']);
                return;
            }
            
            const newDelegation = {
                id: 'DEL' + String(delegationData.length + 1).padStart(3, '0'),
                patientId: formData.patientId,
                patientName: patient.name,
                currentLocation: patient.currentLocation,
                task: formData.task,
                assignedNurse: employee.name,
                employeeId: formData.employeeId,
                qualificationCheck: 'Valid',
                date: formData.date,
                shift: formData.shift,
                delegator: formData.delegator,
                priority: formData.priority,
                status: 'Pending',
                locationMatch: employee.availableLocations && employee.availableLocations.includes(patient.currentLocation) ? 'Valid' : 'Mismatch',
                complianceStatus: 'Compliant'
            };
            
            delegationData.push(newDelegation);
            dataManager.saveData();
            renderDelegationEntry();
            closeModal();
            
            dataManager.showSaveNotification();
        }

        // Filter functions
        function populateEmployeeFilters() {
            const locationFilter = document.getElementById('employeeLocationFilter');
            const uniqueLocations = [...new Set(employeeData.map(emp => emp.primaryLocation))];
            
            locationFilter.innerHTML = '<option value="">All Locations</option>';
            uniqueLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });
        }

        function populatePatientFilters() {
            const locationFilter = document.getElementById('patientLocationFilter');
            const uniqueLocations = [...new Set(patientData.map(p => p.currentLocation))];
            
            locationFilter.innerHTML = '<option value="">All Locations</option>';
            uniqueLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });
        }

        function populateTrackerFilters() {
            const locationFilter = document.getElementById('trackerLocationFilter');
            const uniqueLocations = [...new Set(delegationData.map(d => d.currentLocation))];
            
            locationFilter.innerHTML = '<option value="">All Locations</option>';
            uniqueLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });
        }

        function filterEmployees() {
            // Employee filtering logic would go here
            console.log('Employee filter applied');
        }

        function filterPatients() {
            // Patient filtering logic would go here
            console.log('Patient filter applied');
        }

        function applyTrackerFilters() {
            // Task tracker filtering logic would go here
            console.log('Tracker filters applied');
        }

        // Report functions
        function updateReportOptions() {
            // Populate location dropdown
            const locationSelect = document.getElementById('reportLocation');
            locationSelect.innerHTML = '<option value="">All Locations</option>';
            
            const uniqueLocations = [...new Set(delegationData.map(d => d.currentLocation))];
            uniqueLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationSelect.appendChild(option);
            });
            
            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const location = document.getElementById('reportLocation').value;
            
            let reportData;
            
            switch(reportType) {
                case 'delegation-summary':
                    reportData = ReportGenerator.generateDelegationSummary(startDate, endDate, location);
                    break;
                case 'compliance-report':
                    reportData = ReportGenerator.generateComplianceReport(startDate, endDate, location);
                    break;
                default:
                    alert('Report type not implemented yet.');
                    return;
            }
            
            ReportGenerator.renderReport(reportData, reportType);
        }

        function exportReport() {
            // Simple CSV export
            const reportType = document.getElementById('reportType').value;
            let csvContent = '';
            
            if (reportType === 'delegation-summary') {
                csvContent = 'Patient,Nurse,Task,Date,Status,Location\n';
                delegationData.forEach(d => {
                    csvContent += `"${d.patientName}","${d.assignedNurse}","${d.task}","${d.date}","${d.status}","${d.currentLocation}"\n`;
                });
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${reportType}-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToPDF() {
            alert('PDF export functionality would require a PDF library like jsPDF. This feature would be available in the full SaaS version.');
        }

        // Button functions
        function addNewDelegation() {
            ModalManager.openDelegationModal();
        }

        function validateAllDelegations() {
            let issues = 0;
            delegationData.forEach(delegation => {
                if (delegation.complianceStatus !== 'Compliant') {
                    issues++;
                }
            });
            
            const alertContent = document.getElementById('alertContent');
            if (issues === 0) {
                alertContent.innerHTML = '✅ All delegations are compliant. No issues found.';
            } else {
                alertContent.innerHTML = `⚠️ Found ${issues} compliance issues. Check the Task Tracker for details.`;
            }
        }

        function exportBackup() {
            dataManager.exportData();
        }

        function addNewEmployee() {
            alert('Add New Employee: This feature opens a form to add employee profile with certifications and location assignments. Available in the full SaaS version.');
        }

        function addNewPatient() {
            alert('Add New Patient: This feature opens a form to add patient with location assignment. Available in the full SaaS version.');
        }

        function recordTransfer() {
            alert('Record Transfer: This feature opens a form to record patient transfer between locations. Available in the full SaaS version.');
        }

        function showExpiringCerts() {
            const expiringCount = employeeData.reduce((count, emp) => 
                count + emp.certifications.filter(cert => cert.status === 'expiring' || cert.status === 'expired').length, 0);
            alert(`Found ${expiringCount} certifications that are expired or expiring soon. Check the Compliance Monitor for details.`);
        }

        function editDelegation(id) {
            ModalManager.openDelegationModal(id);
        }

        // Initialize enhanced features
        const dataManager = new DataManager();
        dataManager.enableAutoSave();
        const globalSearch = new GlobalSearch();

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            renderDelegationEntry();
            updateReportOptions();
        });
    </script>
</body>
</html>
